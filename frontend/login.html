<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>SnackForest 登入</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="client/css/client.css">
<link rel="icon" href="data:,">
</head>
<body class="login-page-body" data-require-auth="false">
<main class="login-wrapper">
    <div class="login-card card">
        <div class="card-body p-4 p-md-5">
            <div class="text-center mb-4">
                <div class="login-brand mb-2">SF</div>
                <h1 class="h4 mb-1">SnackForest 登入</h1>
                <p class="text-muted small mb-0">歡迎回來，請先登入您的帳號</p>
            </div>

            <div class="btn-group w-100 mb-3" role="group" aria-label="選擇登入身份">
                <input type="radio" class="btn-check" name="loginRole" id="role-customer" value="customer" autocomplete="off" checked>
                <label class="btn btn-outline-success" for="role-customer">會員登入</label>
                <input type="radio" class="btn-check" name="loginRole" id="role-admin" value="admin" autocomplete="off">
                <label class="btn btn-outline-success" for="role-admin">管理者登入</label>
            </div>

            <div class="form-floating mb-3">
                <input type="text" class="form-control" id="username" placeholder="帳號" autocomplete="username">
                <label for="username">帳號</label>
            </div>
            <div class="form-floating mb-2">
                <input type="password" class="form-control" id="password" placeholder="密碼" autocomplete="current-password">
                <label for="password">密碼</label>
            </div>
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" value="" id="showPwd">
                    <label class="form-check-label" for="showPwd">顯示密碼</label>
                </div>
            </div>

            <button class="w-100 btn btn-lg btn-success" id="loginBtn">
                <span class="spinner-border spinner-border-sm me-2 d-none" id="loginSpinner" role="status" aria-hidden="true"></span>
                登入
            </button>
            <div id="msg" class="alert alert-danger mt-3 d-none" role="alert"></div>
        </div>
    </div>
    <p class="login-footer text-center text-white-50 mt-4">© <span id="y"></span> SnackForest</p>
</main>

<script src="client/js/env.js"></script>
<script>
function setLoading(loading){
    const btn = document.getElementById('loginBtn');
    const sp = document.getElementById('loginSpinner');
    if (loading) {
        btn.setAttribute('disabled','disabled');
        sp.classList.remove('d-none');
    } else {
        btn.removeAttribute('disabled');
        sp.classList.add('d-none');
    }
}

async function doLogin(){
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;
    const roleInput = document.querySelector('input[name="loginRole"]:checked');
    const requestedRole = roleInput ? roleInput.value : 'customer';
    const msg = document.getElementById('msg');
    msg.classList.add('d-none');
    msg.textContent = '';
    if(!username || !password) { msg.textContent = '請輸入帳號密碼'; msg.classList.remove('d-none'); return; }
    setLoading(true);
    try {
        const apiBase = (window.SF_API_BASE || 'http://localhost:8000/api').replace(/\/$/, '');
        const loginUrl = apiBase + '/login';
        const res = await fetch(loginUrl,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({username,password})
        });
        if(!res.ok) {
            let errorText = '登入失敗';
            try { const errorData = await res.json(); if (errorData && errorData.message) errorText = errorData.message; } catch(_){}
            throw new Error(errorText);
        }
        const data = await res.json();
        if(data.success) {
            const resolvedRole = (data.role || '').toLowerCase();

            if (requestedRole === 'admin' && resolvedRole !== 'admin') {
                msg.textContent = '此帳號屬於會員，請改用會員登入或切換帳號。';
                msg.classList.remove('d-none');
                return;
            }

            if (requestedRole === 'customer' && resolvedRole !== 'customer') {
                msg.textContent = '此帳號為管理者，請改用「管理者登入」。';
                msg.classList.remove('d-none');
                return;
            }

            if (!resolvedRole) {
                msg.textContent = '無法判定登入角色，請稍後再試。';
                msg.classList.remove('d-none');
                return;
            }

            localStorage.setItem('userRole', resolvedRole);

            if (resolvedRole === 'customer') {
                if (data.customerId) {
                    localStorage.setItem('customerId', data.customerId);
                    localStorage.setItem('sf-client-id', String(data.customerId));
                }
                if (data.customerName) {
                    localStorage.setItem('customerName', data.customerName);
                    localStorage.setItem('userName', data.customerName);
                    localStorage.setItem('sf-client-name', data.customerName);
                }
                localStorage.setItem('sf-client-role', 'customer');
                try {
                    localStorage.setItem('sf-client-session', JSON.stringify({
                        role: 'customer',
                        customerId: data.customerId ?? null,
                        name: data.customerName || localStorage.getItem('customerName') || '',
                        loginAt: Date.now()
                    }));
                } catch (_) {
                    // ignore storage errors
                }
            } else {
                const fallbackName = data.adminName || data.userName || 'Admin';
                localStorage.setItem('userName', fallbackName);
                localStorage.setItem('sf-admin-role', 'admin');
                localStorage.setItem('sf-admin-name', fallbackName);
                try {
                    localStorage.setItem('sf-admin-session', JSON.stringify({
                        role: 'admin',
                        name: fallbackName,
                        loginAt: Date.now()
                    }));
                } catch (_) {
                    // ignore storage errors
                }
            }
            const nextUrl = resolvedRole === 'admin' ? 'admin/index.html' : 'client/index.html';
            window.location.href = nextUrl;
        } else {
            msg.textContent = data.message || '登入失敗';
            msg.classList.remove('d-none');
        }
    } catch(e) {
        msg.textContent = e.message || '登入失敗';
        msg.classList.remove('d-none');
    } finally {
        setLoading(false);
    }
}

document.getElementById('loginBtn').addEventListener('click', doLogin);
document.getElementById('password').addEventListener('keydown', function(ev){ if(ev.key==='Enter'){ doLogin(); }});
document.getElementById('username').addEventListener('keydown', function(ev){ if(ev.key==='Enter'){ doLogin(); }});
document.getElementById('showPwd').addEventListener('change', function(){
    const pwd = document.getElementById('password');
    pwd.type = this.checked ? 'text' : 'password';
});
document.getElementById('y').textContent = new Date().getFullYear();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
