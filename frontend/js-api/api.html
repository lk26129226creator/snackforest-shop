<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SnackForest API 測試管理介面</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .api-section {
            background: white;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .api-section h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .api-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background: #e0a800;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .input-group label {
            min-width: 100px;
            font-weight: 500;
        }
        
        .input-group input,
        .input-group select,
        .input-group textarea {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .input-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        .response-container {
            margin-top: 20px;
        }
        
        .response-header {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 5px 5px 0 0;
            border: 1px solid #dee2e6;
            font-weight: 500;
        }
        
        .response-body {
            background: #fff;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 5px 5px;
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .response-json {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-size: 13px;
            line-height: 1.4;
        }
        
        .status-success {
            color: #28a745;
            font-weight: bold;
        }
        
        .status-error {
            color: #dc3545;
            font-weight: bold;
        }
        
        .loading {
            color: #6c757d;
            font-style: italic;
        }
        
        .table-container {
            overflow-x: auto;
            margin-top: 15px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .endpoint-url {
            font-family: monospace;
            background: #f8f9fa;
            padding: 5px 10px;
            border-radius: 3px;
            color: #495057;
        }
        
        .connection-status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 10px;
        }
        
        .status-online {
            background: #d4edda;
            color: #155724;
        }
        
        .status-offline {
            background: #f8d7da;
            color: #721c24;
        }
        
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .quick-action-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.2s ease;
        }
        
        .quick-action-card:hover {
            transform: translateY(-2px);
        }
        
        .quick-action-card h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .quick-action-card p {
            color: #666;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🍿 SnackForest API 管理介面</h1>
            <p>測試和管理您的 API 端點 | 服務狀態: <span id="serverStatus" class="connection-status status-offline">離線</span></p>
        </div>

        <!-- 快速操作 -->
        <div class="quick-actions">
            <div class="quick-action-card">
                <h3>🏥 健康檢查</h3>
                <p>檢查伺服器是否正常運行</p>
                <button class="btn btn-success" onclick="checkServerHealth()">檢查狀態</button>
            </div>
            <div class="quick-action-card">
                <h3>� 診斷工具</h3>
                <p>測試所有 API 端點</p>
                <button class="btn btn-warning" onclick="runDiagnostics()">運行診斷</button>
            </div>
            <div class="quick-action-card">
                <h3>�📦 載入所有商品</h3>
                <p>顯示商品列表</p>
                <button class="btn btn-primary" onclick="loadAllProducts()">載入商品</button>
            </div>
            <div class="quick-action-card">
                <h3>🏷️ 載入分類</h3>
                <p>顯示商品分類</p>
                <button class="btn btn-primary" onclick="loadCategories()">載入分類</button>
            </div>
            <div class="quick-action-card">
                <h3>📊 載入訂單</h3>
                <p>顯示訂單資料</p>
                <button class="btn btn-primary" onclick="loadOrders()">載入訂單</button>
            </div>
        </div>

        <!-- 商品管理 -->
        <div class="api-section">
            <h2>📦 商品管理 API</h2>
            
            <div class="api-controls">
                <button class="btn btn-primary" onclick="loadProducts()">GET 載入商品</button>
                <button class="btn btn-success" onclick="showAddProductForm()">POST 新增商品</button>
                <button class="btn btn-warning" onclick="showUpdateProductForm()">PUT 更新商品</button>
                <button class="btn btn-danger" onclick="showDeleteProductForm()">DELETE 刪除商品</button>
            </div>

            <!-- 新增商品表單 -->
            <div id="addProductForm" style="display: none;">
                <h3>新增商品</h3>
                <div class="input-group">
                    <label>商品名稱:</label>
                    <input type="text" id="newProductName" placeholder="輸入商品名稱">
                </div>
                <div class="input-group">
                    <label>價格:</label>
                    <input type="number" id="newProductPrice" placeholder="輸入價格">
                </div>
                <div class="input-group">
                    <label>分類ID:</label>
                    <input type="number" id="newProductCategoryId" placeholder="輸入分類ID">
                </div>
                <button class="btn btn-success" onclick="addProduct()">提交新增</button>
                <button class="btn" onclick="hideForm('addProductForm')">取消</button>
            </div>

            <!-- 更新商品表單 -->
            <div id="updateProductForm" style="display: none;">
                <h3>更新商品</h3>
                <div class="input-group">
                    <label>商品ID:</label>
                    <input type="number" id="updateProductId" placeholder="輸入商品ID">
                </div>
                <div class="input-group">
                    <label>商品名稱:</label>
                    <input type="text" id="updateProductName" placeholder="輸入新名稱">
                </div>
                <div class="input-group">
                    <label>價格:</label>
                    <input type="number" id="updateProductPrice" placeholder="輸入新價格">
                </div>
                <div class="input-group">
                    <label>分類ID:</label>
                    <input type="number" id="updateProductCategoryId" placeholder="輸入分類ID">
                </div>
                <button class="btn btn-warning" onclick="updateProduct()">提交更新</button>
                <button class="btn" onclick="hideForm('updateProductForm')">取消</button>
            </div>

            <!-- 刪除商品表單 -->
            <div id="deleteProductForm" style="display: none;">
                <h3>刪除商品</h3>
                <div class="input-group">
                    <label>商品ID:</label>
                    <input type="number" id="deleteProductId" placeholder="輸入要刪除的商品ID">
                </div>
                <button class="btn btn-danger" onclick="deleteProduct()">確認刪除</button>
                <button class="btn" onclick="hideForm('deleteProductForm')">取消</button>
            </div>

            <div id="productsResponse" class="response-container"></div>
        </div>

        <!-- 分類管理 -->
        <div class="api-section">
            <h2>🏷️ 分類管理 API</h2>
            
            <div class="api-controls">
                <button class="btn btn-primary" onclick="loadCategories()">GET 載入分類</button>
                <button class="btn btn-success" onclick="showAddCategoryForm()">POST 新增分類</button>
                <button class="btn btn-danger" onclick="showDeleteCategoryForm()">DELETE 刪除分類</button>
            </div>

            <!-- 新增分類表單 -->
            <div id="addCategoryForm" style="display: none;">
                <h3>新增分類</h3>
                <div class="input-group">
                    <label>分類名稱:</label>
                    <input type="text" id="newCategoryName" placeholder="輸入分類名稱">
                </div>
                <button class="btn btn-success" onclick="addCategory()">提交新增</button>
                <button class="btn" onclick="hideForm('addCategoryForm')">取消</button>
            </div>

            <!-- 刪除分類表單 -->
            <div id="deleteCategoryForm" style="display: none;">
                <h3>刪除分類</h3>
                <div class="input-group">
                    <label>分類ID:</label>
                    <input type="number" id="deleteCategoryId" placeholder="輸入要刪除的分類ID">
                </div>
                <button class="btn btn-danger" onclick="deleteCategory()">確認刪除</button>
                <button class="btn" onclick="hideForm('deleteCategoryForm')">取消</button>
            </div>

            <div id="categoriesResponse" class="response-container"></div>
        </div>

        <!-- 訂單管理 -->
        <div class="api-section">
            <h2>📊 訂單管理 API</h2>
            
            <div class="api-controls">
                <button class="btn btn-primary" onclick="loadOrders()">GET 載入訂單</button>
                <button class="btn btn-success" onclick="showCreateOrderForm()">POST 建立訂單</button>
            </div>

            <!-- 建立訂單表單 -->
            <div id="createOrderForm" style="display: none;">
                <h3>建立測試訂單</h3>
                <div class="input-group">
                    <label>訂單項目 (JSON):</label>
                    <textarea id="orderItems" placeholder='[{"id":1,"name":"商品名稱","price":100,"quantity":2}]'></textarea>
                </div>
                <div class="input-group">
                    <label>總金額:</label>
                    <input type="number" id="orderTotal" placeholder="輸入總金額">
                </div>
                <div class="input-group">
                    <label>客戶ID (可選):</label>
                    <input type="number" id="customerId" placeholder="輸入客戶ID">
                </div>
                <button class="btn btn-success" onclick="createOrder()">建立訂單</button>
                <button class="btn" onclick="hideForm('createOrderForm')">取消</button>
            </div>

            <div id="ordersResponse" class="response-container"></div>
        </div>

        <!-- 系統資訊 -->
        <div class="api-section">
            <h2>🔧 系統測試</h2>
            
            <div class="api-controls">
                <button class="btn btn-primary" onclick="testPing()">Ping 測試</button>
                <button class="btn btn-primary" onclick="testDatabase()">資料庫測試</button>
                <button class="btn btn-primary" onclick="loadSnackforestData()">載入 Snackforest 資料</button>
            </div>

            <div id="systemResponse" class="response-container"></div>
        </div>
    </div>

    <script>
        // 基本設定
        const API_BASE = 'http://localhost:8000';  // 使用完整 URL 進行測試
        let serverOnline = false;

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 API 管理介面已載入');
            console.log('🔍 開始初始化檢查...');
            
            // 顯示當前頁面資訊
            console.log('當前頁面 URL:', window.location.href);
            console.log('API_BASE 設定:', API_BASE || '(空字串 - 使用相對路徑)');
            
            // 添加修復按鈕
            addFixButton();
            
            // 執行健康檢查
            checkServerHealth();
            
            // 延遲執行額外檢查
            setTimeout(() => {
                console.log('🔧 執行快速連接測試...');
                quickConnectionTest();
            }, 1000);
        });

        // 添加修復按鈕
        function addFixButton() {
            try {
                const actionCards = document.querySelectorAll('.quick-action-card');
                if (actionCards.length > 1) {
                    const diagCard = actionCards[1]; // 診斷工具卡片
                    const fixButton = document.createElement('button');
                    fixButton.className = 'btn btn-success';
                    fixButton.style.marginTop = '10px';
                    fixButton.textContent = '修復商品資料';
                    fixButton.onclick = fixProductData;
                    diagCard.appendChild(fixButton);
                }
            } catch (error) {
                console.error('添加修復按鈕失敗:', error);
            }
        }

        // 快速連接測試
        async function quickConnectionTest() {
            try {
                const response = await fetch(`${API_BASE}/api/products`, { method: 'HEAD' });
                if (response.ok) {
                    console.log('✅ API 端點快速測試通過');
                } else {
                    console.warn('⚠️ API 端點快速測試失敗:', response.status);
                }
            } catch (error) {
                console.error('❌ API 端點快速測試錯誤:', error.message);
            }
        }

        // 通用 API 呼叫函數
        async function apiCall(endpoint, method = 'GET', data = null, responseContainer = null) {
            try {
                showLoading(responseContainer);
                
                const fullUrl = `${API_BASE}${endpoint}`;
                console.log(`🔗 發送請求到: ${fullUrl}`);
                console.log(`📄 請求方法: ${method}`);
                console.log(`📦 請求資料:`, data);
                
                const options = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (data) {
                    options.body = JSON.stringify(data);
                }
                
                const response = await fetch(fullUrl, options);
                
                console.log(`📡 回應狀態: ${response.status} ${response.statusText}`);
                console.log(`📋 回應標頭:`, [...response.headers.entries()]);
                
                // 檢查回應狀態
                if (!response.ok) {
                    console.error(`❌ HTTP 錯誤: ${response.status} ${response.statusText}`);
                    console.error(`🔗 請求的 URL: ${fullUrl}`);
                    
                    // 嘗試讀取錯誤回應內容
                    try {
                        const errorText = await response.text();
                        console.error(`📄 錯誤回應內容:`, errorText);
                    } catch (e) {
                        console.error(`📄 無法讀取錯誤回應內容:`, e);
                    }
                    
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                // 檢查 Content-Type 是否為 JSON
                const contentType = response.headers.get('content-type');
                
                // 先獲取回應文本
                const textContent = await response.text();
                console.log(`📄 回應內容:`, textContent);
                
                // 如果回應為空或只有空白字符
                if (!textContent || textContent.trim() === '') {
                    console.log(`✅ 收到空回應 (通常表示操作成功)`);
                    const result = { success: true, message: '操作成功' };
                    
                    if (responseContainer) {
                        displayResponse(response.status, result, responseContainer, endpoint, method);
                    }
                    
                    return { status: response.status, data: result };
                }
                
                // 檢查是否為 JSON 格式
                if (!contentType || !contentType.includes('application/json')) {
                    console.error('伺服器返回非 JSON 內容:', textContent.substring(0, 200));
                    throw new Error(`伺服器返回了 ${contentType || 'unknown'} 而不是 JSON`);
                }
                
                // 嘗試解析 JSON
                let result;
                try {
                    result = JSON.parse(textContent);
                } catch (jsonError) {
                    console.error('JSON 解析失敗:', jsonError);
                    console.error('原始回應內容:', textContent);
                    throw new Error(`JSON 解析失敗: ${jsonError.message}`);
                }
                
                console.log(`✅ 成功接收資料:`, result);
                
                if (responseContainer) {
                    displayResponse(response.status, result, responseContainer, endpoint, method);
                }
                
                return { status: response.status, data: result };
                
            } catch (error) {
                console.error('API 呼叫錯誤:', error);
                if (responseContainer) {
                    displayError(error.message, responseContainer, endpoint, method);
                }
                return { status: 'error', data: { error: error.message } };
            }
        }

        // 顯示載入狀態
        function showLoading(container) {
            if (container) {
                document.getElementById(container).innerHTML = `
                    <div class="response-header">
                        <span class="loading">載入中...</span>
                    </div>
                `;
            }
        }

        // 顯示回應
        function displayResponse(status, data, container, endpoint, method) {
            const statusClass = status >= 200 && status < 300 ? 'status-success' : 'status-error';
            const containerEl = document.getElementById(container);
            
            containerEl.innerHTML = `
                <div class="response-header">
                    <span class="${statusClass}">狀態: ${status}</span>
                    <span class="endpoint-url">${method} ${endpoint}</span>
                </div>
                <div class="response-body">
                    <div class="response-json">${JSON.stringify(data, null, 2)}</div>
                    ${Array.isArray(data) ? generateTable(data) : ''}
                </div>
            `;
        }

        // 顯示錯誤
        function displayError(error, container, endpoint, method) {
            const containerEl = document.getElementById(container);
            
            // 檢查是否是詳細的錯誤對象
            let errorDetails = error;
            if (typeof error === 'object' && error.message) {
                errorDetails = error.message;
            }
            
            containerEl.innerHTML = `
                <div class="response-header">
                    <span class="status-error">錯誤: 請求失敗</span>
                    <span class="endpoint-url">${method} ${endpoint}</span>
                </div>
                <div class="response-body">
                    <div class="response-json" style="color: #dc3545;">
                        <strong>錯誤訊息:</strong> ${errorDetails}<br><br>
                        <strong>可能原因:</strong><br>
                        • 伺服器未運行或已停止<br>
                        • API 端點不存在或路徑錯誤<br>
                        • 網路連線問題<br>
                        • CORS 設定問題<br><br>
                        <strong>除錯建議:</strong><br>
                        1. 檢查伺服器是否正在運行<br>
                        2. 確認 API 端點路徑正確<br>
                        3. 查看瀏覽器開發者工具的 Network 標籤<br>
                        4. 點擊上方的 "🔧 診斷工具" 獲取詳細資訊
                    </div>
                </div>
            `;
        }

        // 生成表格
        function generateTable(data) {
            if (!Array.isArray(data) || data.length === 0) return '';
            
            const headers = Object.keys(data[0]);
            const rows = data.map(item => 
                `<tr>${headers.map(header => `<td>${item[header] || ''}</td>`).join('')}</tr>`
            ).join('');
            
            return `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>${headers.map(header => `<th>${header}</th>`).join('')}</tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
        }

        // 表單顯示/隱藏
        function showForm(formId) {
            document.getElementById(formId).style.display = 'block';
        }

        function hideForm(formId) {
            document.getElementById(formId).style.display = 'none';
        }

        // 系統健康檢查
        async function checkServerHealth() {
            try {
                const response = await fetch(`${API_BASE}/ping`);
                if (response.ok) {
                    serverOnline = true;
                    document.getElementById('serverStatus').className = 'connection-status status-online';
                    document.getElementById('serverStatus').textContent = '線上';
                    
                    // 同時測試 API 端點
                    const apiResponse = await fetch(`${API_BASE}/api/products`);
                    if (!apiResponse.ok) {
                        console.warn('API 端點可能有問題:', apiResponse.status, apiResponse.statusText);
                    }
                } else {
                    throw new Error('伺服器回應異常');
                }
            } catch (error) {
                serverOnline = false;
                document.getElementById('serverStatus').className = 'connection-status status-offline';
                document.getElementById('serverStatus').textContent = '離線';
                console.error('健康檢查失敗:', error);
            }
        }

        // 診斷函數 - 測試 API 端點
        async function testApiEndpoint(endpoint) {
            try {
                console.log(`測試端點: ${endpoint}`);
                const response = await fetch(endpoint);
                console.log(`狀態: ${response.status}`);
                console.log(`Content-Type: ${response.headers.get('content-type')}`);
                
                const text = await response.text();
                console.log(`回應內容 (前 200 字符):`, text.substring(0, 200));
                
                // 嘗試解析為 JSON
                if (response.headers.get('content-type')?.includes('application/json')) {
                    const json = JSON.parse(text);
                    console.log('JSON 解析成功:', json);
                } else {
                    console.warn('非 JSON 回應');
                }
                
                return true;
            } catch (error) {
                console.error(`端點 ${endpoint} 測試失敗:`, error);
                return false;
            }
        }

        // 運行完整診斷
        async function runDiagnostics() {
            console.log('🔧 開始運行 API 診斷...');
            
            // 創建診斷結果顯示區域
            const diagnosticsContainer = document.createElement('div');
            diagnosticsContainer.className = 'api-section';
            diagnosticsContainer.innerHTML = '<h2>🔧 診斷結果</h2><div id="diagnosticsResults">正在運行診斷...</div>';
            
            // 插入到頁面中
            const container = document.querySelector('.container');
            container.appendChild(diagnosticsContainer);
            
            const resultsDiv = document.getElementById('diagnosticsResults');
            let results = '';
            
            const endpoints = [
                '/ping',
                '/api/products',
                '/api/categories',
                '/api/order',
                '/api/snackforest'
            ];
            
            for (const endpoint of endpoints) {
                results += `<h4>測試端點: ${API_BASE}${endpoint}</h4>`;
                
                try {
                    const response = await fetch(`${API_BASE}${endpoint}`);
                    const contentType = response.headers.get('content-type');
                    const text = await response.text();
                    
                    results += `
                        <div style="background: #f8f9fa; padding: 10px; margin: 10px 0; border-radius: 5px;">
                            <strong>狀態:</strong> <span style="color: ${response.ok ? 'green' : 'red'}">${response.status} ${response.statusText}</span><br>
                            <strong>Content-Type:</strong> ${contentType}<br>
                            <strong>回應內容:</strong><br>
                            <pre style="max-height: 200px; overflow-y: auto; background: white; padding: 10px; border: 1px solid #ddd;">${text.substring(0, 500)}${text.length > 500 ? '...' : ''}</pre>
                        </div>
                    `;
                    
                    console.log(`✅ ${endpoint}: ${response.status}`);
                } catch (error) {
                    results += `
                        <div style="background: #ffebee; padding: 10px; margin: 10px 0; border-radius: 5px; border-left: 4px solid red;">
                            <strong>錯誤:</strong> ${error.message}
                        </div>
                    `;
                    console.error(`❌ ${endpoint}: ${error.message}`);
                }
                
                results += '<hr>';
                resultsDiv.innerHTML = results;
                
                // 短暫延遲，讓用戶看到進度
                await new Promise(resolve => setTimeout(resolve, 500));
            }
            
            results += '<p><strong>診斷完成！</strong></p>';
            resultsDiv.innerHTML = results;
            
            console.log('診斷完成！');
        }

        // 快速操作函數
        async function loadAllProducts() {
            await apiCall('/api/products', 'GET', null, 'productsResponse');
        }

        // 商品相關函數
        async function loadProducts() {
            await apiCall('/api/products', 'GET', null, 'productsResponse');
        }

        function showAddProductForm() {
            showForm('addProductForm');
            hideForm('updateProductForm');
            hideForm('deleteProductForm');
        }

        function showUpdateProductForm() {
            showForm('updateProductForm');
            hideForm('addProductForm');
            hideForm('deleteProductForm');
        }

        function showDeleteProductForm() {
            showForm('deleteProductForm');
            hideForm('addProductForm');
            hideForm('updateProductForm');
        }

        async function addProduct() {
            const name = document.getElementById('newProductName').value;
            const price = parseInt(document.getElementById('newProductPrice').value);
            const categoryId = parseInt(document.getElementById('newProductCategoryId').value);
            
            if (!name || !price || !categoryId) {
                alert('請填寫所有必填欄位');
                return;
            }
            
            const data = {
                ProductName: name,
                Price: price,
                CategoriesID: categoryId
            };
            
            await apiCall('/api/products', 'POST', data, 'productsResponse');
            hideForm('addProductForm');
            
            // 清空表單
            document.getElementById('newProductName').value = '';
            document.getElementById('newProductPrice').value = '';
            document.getElementById('newProductCategoryId').value = '';
        }

        async function updateProduct() {
            const id = parseInt(document.getElementById('updateProductId').value);
            const name = document.getElementById('updateProductName').value;
            const price = parseInt(document.getElementById('updateProductPrice').value);
            const categoryId = parseInt(document.getElementById('updateProductCategoryId').value);
            
            if (!id) {
                alert('請輸入商品ID');
                return;
            }
            
            try {
                // 先獲取現有商品資料
                console.log(`🔍 獲取商品 ${id} 的現有資料...`);
                const currentProductResponse = await apiCall(`/api/products/${id}`, 'GET', null, null);
                
                if (currentProductResponse.status === 'error' || !currentProductResponse.data) {
                    alert(`找不到商品 ID ${id}，請確認商品存在`);
                    return;
                }
                
                const currentProduct = currentProductResponse.data;
                console.log(`✅ 當前商品資料:`, currentProduct);
                
                // 構建更新資料，保留原有的圖片和其他欄位
                const data = {
                    name: name || currentProduct.name,
                    price: price || currentProduct.price,
                    categoryId: categoryId || currentProduct.categoryId,
                    imageUrls: currentProduct.imageUrls || [],  // 保留原有圖片
                    introduction: currentProduct.introduction || "",
                    origin: currentProduct.origin || "",
                    productionDate: currentProduct.productionDate || "",
                    expiryDate: currentProduct.expiryDate || ""
                };
                
                console.log(`📝 準備更新的資料:`, data);
                
                // 執行更新
                await apiCall(`/api/products/${id}`, 'PUT', data, 'productsResponse');
                hideForm('updateProductForm');
                
                // 清空表單
                document.getElementById('updateProductId').value = '';
                document.getElementById('updateProductName').value = '';
                document.getElementById('updateProductPrice').value = '';
                document.getElementById('updateProductCategoryId').value = '';
                
                // 重新載入商品列表以顯示更新結果
                setTimeout(() => {
                    loadProducts();
                }, 500);
                
            } catch (error) {
                console.error('更新商品時發生錯誤:', error);
                alert('更新失敗: ' + error.message);
            }
        }

        async function deleteProduct() {
            const id = parseInt(document.getElementById('deleteProductId').value);
            
            if (!id) {
                alert('請輸入商品ID');
                return;
            }
            
            if (confirm(`確定要刪除商品 ID ${id} 嗎？`)) {
                await apiCall(`/api/products/${id}`, 'DELETE', null, 'productsResponse');
                hideForm('deleteProductForm');
                document.getElementById('deleteProductId').value = '';
            }
        }

        // 分類相關函數
        async function loadCategories() {
            await apiCall('/api/categories', 'GET', null, 'categoriesResponse');
        }

        function showAddCategoryForm() {
            showForm('addCategoryForm');
            hideForm('deleteCategoryForm');
        }

        function showDeleteCategoryForm() {
            showForm('deleteCategoryForm');
            hideForm('addCategoryForm');
        }

        async function addCategory() {
            const name = document.getElementById('newCategoryName').value;
            
            if (!name) {
                alert('請輸入分類名稱');
                return;
            }
            
            const data = { categoryname: name };
            await apiCall('/api/categories', 'POST', data, 'categoriesResponse');
            hideForm('addCategoryForm');
            document.getElementById('newCategoryName').value = '';
        }

        async function deleteCategory() {
            const id = parseInt(document.getElementById('deleteCategoryId').value);
            
            if (!id) {
                alert('請輸入分類ID');
                return;
            }
            
            if (confirm(`確定要刪除分類 ID ${id} 嗎？`)) {
                await apiCall(`/api/categories/${id}`, 'DELETE', null, 'categoriesResponse');
                hideForm('deleteCategoryForm');
                document.getElementById('deleteCategoryId').value = '';
            }
        }

        // 訂單相關函數
        async function loadOrders() {
            await apiCall('/api/order', 'GET', null, 'ordersResponse');
        }

        function showCreateOrderForm() {
            showForm('createOrderForm');
        }

        async function createOrder() {
            try {
                const itemsJson = document.getElementById('orderItems').value;
                const total = parseFloat(document.getElementById('orderTotal').value);
                const customerId = document.getElementById('customerId').value;
                
                const items = JSON.parse(itemsJson);
                
                if (!items || !Array.isArray(items) || items.length === 0) {
                    alert('請輸入有效的訂單項目 JSON');
                    return;
                }
                
                if (!total || total <= 0) {
                    alert('請輸入有效的總金額');
                    return;
                }
                
                const data = {
                    items: items,
                    total: total
                };
                
                if (customerId) {
                    data.customerId = parseInt(customerId);
                }
                
                await apiCall('/api/order', 'POST', data, 'ordersResponse');
                hideForm('createOrderForm');
                
            } catch (error) {
                alert('訂單資料格式錯誤: ' + error.message);
            }
        }

        // 系統測試函數
        async function testPing() {
            await apiCall('/ping', 'GET', null, 'systemResponse');
        }

        async function testDatabase() {
            await apiCall('/api/debug/db', 'GET', null, 'systemResponse');
        }

        async function loadSnackforestData() {
            await apiCall('/api/snackforest', 'GET', null, 'systemResponse');
        }

        // 修復商品資料
        async function fixProductData() {
            if (!confirm('確定要修復商品資料嗎？這將恢復正確的商品名稱、介紹和基本圖片。')) {
                return;
            }

            const fixedProducts = [
                {
                    id: 1,
                    name: "洋芋片",
                    price: 105,
                    categoryId: 1,
                    imageUrls: [],
                    introduction: "香脆可口的洋芋片，精選優質馬鈴薯製作",
                    origin: "台灣",
                    productionDate: "2025-09-27",
                    expiryDate: "2025-12-27"
                }
            ];

            let successCount = 0;
            let failCount = 0;

            for (const product of fixedProducts) {
                try {
                    console.log(`修復商品 ${product.id}: ${product.name}`);
                    
                    // 使用更詳細的 API 呼叫，確保編碼正確
                    const fullUrl = `${API_BASE}/api/products/${product.id}`;
                    console.log(`🔗 發送修復請求到: ${fullUrl}`);
                    
                    const response = await fetch(fullUrl, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json; charset=utf-8',
                        },
                        body: JSON.stringify(product)
                    });
                    
                    console.log(`📡 修復回應狀態: ${response.status}`);
                    
                    if (response.ok) {
                        successCount++;
                        console.log(`✅ 商品 ${product.id} 修復成功`);
                    } else {
                        failCount++;
                        console.error(`❌ 商品 ${product.id} 修復失敗: ${response.status}`);
                    }
                } catch (error) {
                    failCount++;
                    console.error(`❌ 商品 ${product.id} 修復錯誤:`, error);
                }
                
                // 短暫延遲避免請求過快
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            alert(`修復完成！成功: ${successCount} 件，失敗: ${failCount} 件`);
            
            // 重新載入商品列表
            setTimeout(() => {
                loadAllProducts();
            }, 1000);
        }

        // 自動重新整理伺服器狀態
        setInterval(checkServerHealth, 30000); // 每30秒檢查一次
    </script>
</body>
</html>